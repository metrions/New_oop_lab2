<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ–ª–µ—Ñ–æ–Ω–Ω–∞—è –∫–Ω–∏–≥–∞</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .container { width: 700px; margin: 20px auto; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
        .table-container { width: 80%; height: 320px; border: 1px solid #ccc; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
        tr { cursor: pointer; }
        tr:hover { background-color: #f0f0f0; }
        .buttons { display: flex; flex-direction: column; align-items: flex-end; margin-left: 10px; }
        .buttons button { width: 100px; margin: 2px 0; }
        .form-group {
            display: flex;
            justify-content: flex-start;
            margin-top: 5px;
        }
        .form-group label {
            width: 100px;
            text-align: left;
            padding-right: 10px;
        }
        .form-group input {
            width: 200px;
        }
        .bottom-form { display: flex; justify-content: space-between; margin-left: 10px; margin-top: 5px; }
        .row { display: flex; flex-direction: row; align-items: flex-start; }
    </style>
</head>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const form = document.querySelector("form[action='/add']");

        if (!form) {
            console.error("–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!");
            return;
        }

        form.addEventListener("submit", function (event) {
            const phoneInput = form.querySelector("input[name='phone']");
            const phone = phoneInput.value.trim();

            if (isPhoneExists(phone)) {
                alert("–≠—Ç–æ—Ç –Ω–æ–º–µ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
                event.preventDefault(); // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
            }
        });

        function isPhoneExists(phone) {
            const rows = document.querySelectorAll("tbody tr");
            for (let row of rows) {
                const existingPhone = row.querySelector("td:last-child").textContent.trim();
                if (existingPhone === phone) {
                    return true;
                }
            }
            return false;
        }
    });
</script>
<body>
<div class="container">
    <p><a href="/help" target="_blank">üìñ –°–ø—Ä–∞–≤–∫–∞</a></p>

    <h3>–¢–µ–ª–µ—Ñ–æ–Ω–Ω–∞—è –∫–Ω–∏–≥–∞</h3>

    <!-- –û–∫–Ω–æ –≤—ã–≤–æ–¥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ -->
    <div class="row">
        <div class="table-container">
            <table>
                <thead>
                <tr>
                    <th>–§–ò–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="contact : ${contacts}" onclick="selectContact(this)">
                    <td th:text="${contact.name}">–°–∞—à–∞</td>
                    <td th:text="${contact.phone}">233555</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="buttons">
            <button onclick="clearContacts()">–û—á–∏—Å—Ç–∏—Ç—å</button>
            <button onclick="deleteSelected()">–£–¥–∞–ª–∏—Ç—å</button>
            <button onclick="openEditModal()">–ò–∑–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <h4>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h4>
    <form th:action="@{/add}" method="post">
        <div class="row">
            <div>
                <div class="form-group">
                    <label>–§–ò–û</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>–ù–æ–º–µ—Ä</label>
                    <input type="text" name="phone" required>
                </div>
            </div>
            <div class="bottom-form">
                <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
        </div>
    </form>

    <!-- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 20px; border: 1px solid black;">
        <h3>–ò–∑–º–µ–Ω–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
        <form id="editForm" method="post" action="/edit">
            <input type="hidden" name="oldName" id="oldName">
            <input type="hidden" name="oldPhone" id="oldPhone">
            <label>–ù–æ–≤–æ–µ –§–ò–û:</label>
            <input type="text" name="newName" id="newName" required>
            <label>–ù–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:</label>
            <input type="text" name="newPhone" id="newPhone" required>
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button type="button" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –ø–æ–∏—Å–∫–∞ -->
    <h4>–ù–∞–π—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç</h4>
    <form th:action="@{/search}" method="post">
        <div class="row">
            <div>
                <div class="form-group">
                    <input type="text" name="name" placeholder="–ò–º—è" />
                </div>
                <div class="form-group">
                    <input type="text" name="phone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" />
                </div>
            </div>
            <div class="bottom-form">
                <button type="submit">–ù–∞–π—Ç–∏</button>
            </div>
        </div>
    </form>


    <h4>–ò–º–ø–æ—Ä—Ç/–≠–∫—Å–ø–æ—Ä—Ç</h4>
    <form id="importForm" th:action="@{/importCSV}" method="post" enctype="multipart/form-data">
        <div class="row">
            <button type="button" onclick="document.getElementById('fileInput').click()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <input type="file" id="fileInput" name="file" accept=".csv" required style="display: none" onchange="autoSubmitImport()">
        </div>
    </form>

    <!-- –≠–∫—Å–ø–æ—Ä—Ç -->
    <div class="row">
        <button type="button" onclick="chooseFileAndSave()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>

</div>

<script>

    let selectedContact = null;

    function autoSubmitImport() {
        document.getElementById("importForm").submit();
    }

    async function chooseFileAndSave() {
        try {
            const handle = await window.showSaveFilePicker({
                suggestedName: "contacts.csv",
                types: [{
                    description: "CSV —Ñ–∞–π–ª—ã",
                    accept: { "text/csv": [".csv"] }
                }]
            });

            const response = await fetch(`/saveToFile`);
            if (!response.ok) {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞!");
                return;
            }
            const text = await response.text();

            const writable = await handle.createWritable();
            await writable.write(text);
            await writable.close();

            alert("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");

        } catch (error) {
            console.error(error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞!");
        }
    }

    // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏
    function selectContact(element) {
        if (selectedContact) {
            selectedContact.classList.remove("selected");
        }
        selectedContact = element;
        selectedContact.classList.add("selected");
    }

    function clearContacts() {
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '/clear';
        document.body.appendChild(form);
        form.submit();
    }

    function openEditModal() {
        if (!selectedContact) {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!");
            return;
        }

        const oldName = selectedContact.querySelector("td:first-child").innerText;
        const oldPhone = selectedContact.querySelector("td:last-child").innerText;

        document.getElementById("oldName").value = oldName;
        document.getElementById("oldPhone").value = oldPhone;
        document.getElementById("newName").value = oldName;
        document.getElementById("newPhone").value = oldPhone;

        document.getElementById("editModal").style.display = "block";
    }

    function closeEditModal() {
        document.getElementById("editModal").style.display = "none";
    }


    // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–∞–∫—Ç–∞
    function deleteSelected() {
        if (selectedContact) {
            const name = selectedContact.querySelector('td:first-child').innerText;
            const phone = selectedContact.querySelector('td:last-child').innerText;

            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/delete';
            console.log(form);

            const nameInput = document.createElement('input');
            nameInput.type = 'hidden';
            nameInput.name = 'name';
            nameInput.value = name;
            form.appendChild(nameInput);

            const phoneInput = document.createElement('input');
            phoneInput.type = 'hidden';
            phoneInput.name = 'phone';
            phoneInput.value = phone;
            form.appendChild(phoneInput);

            document.body.appendChild(form);
            form.submit();
        } else {
            alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!");
        }
    }

</script>
</body>
</html>
